"""add_bmres_timestamp_index

Revision ID: fe3b1041ed15
Revises: 21519d1e3ddb
Create Date: 2023-03-01 15:41:25.181769

"""
from alembic import op

# revision identifiers, used by Alembic.
revision = "fe3b1041ed15"
down_revision = "21519d1e3ddb"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Concurrent index creation must not run as part of a transaction. The
    # autocommit block context manager ensures exactly that. Also see
    # https://github.com/conbench/conbench/pull/788#issuecomment-1451717944
    with op.get_context().autocommit_block():
        op.create_index(
            "benchmark_result_timestamp_index",
            "benchmark_result",
            ["timestamp"],
            unique=False,
            # https://docs.sqlalchemy.org/en/14/dialects/postgresql.html#indexes-with-concurrently
            # https://www.postgresql.org/docs/current/sql-createindex.html#SQL-CREATEINDEX-CONCURRENTLY
            postgresql_concurrently=True,
        )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("benchmark_result_timestamp_index", table_name="benchmark_result")
    # ### end Alembic commands ###
