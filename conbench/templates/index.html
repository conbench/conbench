{% extends "app.html" %}

{% block app_content %}


<h1 class="display-3 text-center" style="margin-bottom: 40px">/ˈkɒnbɛnʧ/</h1>

{% for repo_url, runobjs in repo_runs_map.items() %}
<div class="p-0">
  <h4>Recent runs</h4>
  <p>for <a href="{{repo_url}}">{{repo_url}}</a></p>
</div>
<hr class="border border-danger border-1 opacity-50">
<!-- https://getbootstrap.com/docs/5.2/content/tables/#responsive-tables -->
<div class="table-responsive" style="margin-bottom: 50px">
<!-- wow, the width:100% on the table below is really important, otherwise
     datatables might miscalculate the column widths, but only when using
     colspan in the header. I got that pointer in this thread:
     https://datatables.net/forums/discussion/comment/144435/#Comment_144435
     but otherwise spent way too much time debugging. This structure repeats,
     and only the _first_ table had properties
-->
<table class="cb-runs-table table table-hover" style="width:100%; display: none">
<thead>
    {# https://datatables.net/examples/basic_init/complex_header.html #}
    <tr>
        <th scope="colgroup" colspan="3">Run</th>
        <th scope="colgroup" colspan="3">Commit</th>
    </tr>
    <tr>
        <!-- add tooltip, saying that this is DB insertion time -->
        <th scope="col" style="width: 180px">insertion time</th>
        <th scope="col" class="reason-col">reason</th>
        <th scope="col" style="width: 150px">hardware</th>
        <th scope="col" style="width: 170px">author</th>
        <th scope="col" class="commit-col" style="width: 90px">hash</th>
        <th scope="col">message</th>
    </tr>
</thead>

<tbody>
  {% for r in runobjs %}
  <tr>
    <td style="white-space: nowrap;">
        <a href="{{ url_for('app.run', run_id=r.run.id) }}">{{ r.ctime_for_table }}</a>
        {% if r.run.has_errors or r.run.error_info %}
            <i class="bi bi-exclamation-circle text-danger"
              data-toggle="tooltip"
              data-placement="top"
              title="This Run contains at least one benchmark result with an error"></i>
        {% endif %}
    </td>

    <td>
      {% if r.run.reason %}
        <div class="table-entry">{{ r.run.reason }}</div>
      {% else %}
        <div class="table-entry"></div>
      {% endif %}
    </td>

    <td><div class="table-entry">{{ r.run.hardware.name }}</div></td>

    <td>
      <div class="table-entry">
        {% if r.run.commit.author_avatar_url is not none %}
          <img alt="avatar" src="{{ r.run.commit.author_avatar_url  }}" height="25" style="border-radius: 50%;">&nbsp;
        {% endif %}
        {{ r.run.commit.author_name }}
      </div>
    </td>

    <td>
      {% if r.run.commit.commit_url is not none %}
        <a href="{{ r.run.commit.commit_url }}">{{ r.run.commit.hash[:7] }}</a>
      {% else %}
        {# is this a valid scenario? when there's a hash, but no url? #}
        {{ r.run.commit.hash[:7] }}
      {% endif %}
      <!--NOTE: enable full commit has search while maintaining partial hash display -->
      <p style="display:none">{{ r.run.commit.hash }}</p>
    </td>
    <td>{{ r.commit_message_short }}</td>
  </tr>
  {% endfor %}
</tbody>
</table>
</div>
{% endfor %}

{% endblock %}


{% block scripts %}
{{super()}}
<script>
  var table = $('#runs').DataTable({
      // the default default seems to be the first item in lengthMenu.
      "lengthMenu": [ 5, 10, 50, 75, 100 ],
      // but when pageLength is also set, then _this_ is the default.
      "pageLength": 10,
      "order": [[0, 'desc']],
      // https://datatables.net/reference/option/dom
      // put `l` to the bottom
      "dom": "lfrtip",
      //"lengthMenu": [ 20, 25, 50, 75, 100 ],
      // Make "Commit" (commit hash) column (4) more narrow, hide 'sorting'
      // toggle. Sorting by commit hash is not needed, in particular because
      // one can filter by commit hash via input field. Do the same for the
      // "Commit author" column (1), and the "Commit message" columnn (5).
      // First column has index 0.
      "columnDefs": [{ "orderable": false, "targets": [1, 4, 5] }],
      "language": {
          "searchPlaceholder": "search across all columns",
      },
      initComplete: function () {
        var api = this.api();
        $('#runs').show();
        api.columns.adjust();
      }
});


enable_search_query_string('#runs');

/* specify the HTML table id (string) for
 which search functionality should be enabled
*/
column_search_implementation('#runs');

</script>
{% endblock %}
