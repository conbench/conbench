name: build

on:
  push:
    branches:
      - main
  pull_request:

env:
  PYTHON_VERSION: "3.8"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout conbench
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Lint (black)
        uses: psf/black@stable
        with:
          options: --check --diff
          src: .
      - name: Install dependencies
        run: |
          pip install --no-deps \
            -e benchadapt/python \
            -e benchrun/python \
            -e benchconnect && \
          pip install \
            -U --upgrade-strategy eager \
            -e .[dev] \
            -e benchclients/python
      - name: Start PostgreSQL DB
        run: |
          docker-compose run --detach db
      # Run `alembic upgrade head` via docker-compose so that it is within
      # the network that the DB is also in, reachable via DNS name `db`
      - name: Migrations
        run: |
          docker-compose run -e CREATE_ALL_TABLES app alembic upgrade head
        env:
          CREATE_ALL_TABLES: false
      - name: Lint (flake8)
        run: |
          flake8
      - name: Lint (isort)
        run: |
          isort --check .
      - name: Run tests, generate coverage report
        run: |
          docker-compose down && \
          docker-compose build app && \
          docker-compose run app coverage run \
            --data-file=/etc/conbench-coverage-dir/.coverage --source conbench \
              -m pytest -vv -s -k test_dynamic_callback_url --durations=20 conbench/tests/
      - name: Publish coverage
        run: |
          docker-compose run app coveralls --service=github
        env:
          COVERAGE_FILE: /etc/conbench-coverage-dir/.coverage
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Test benchclients
        run: |
          pytest -vv benchclients/python/tests
      - name: Test benchadapt
        run: |
          pytest -vv benchadapt/python/tests
      - name: Test benchrun
        run: |
          pytest -vv benchrun/python/tests
      - name: Test benchconnect
        run: |
          pytest -vv benchconnect
